---
import BaseLayout from '../layouts/BaseLayout.astro';
import Timeline from '../components/Timeline.astro';
import ProjectBlock from '../components/ProjectBlock.astro';
import FilterBar from '../components/FilterBar.astro';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');
const projects = allProjects
  .filter(p => import.meta.env.DEV || !p.data.draft)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Pre-render content and group by year for year dividers
const renderedProjects = await Promise.all(
  projects.map(async (project) => {
    const { Content } = await project.render();
    const year = new Date(project.data.date).getFullYear();
    return { project, Content, year };
  })
);

const byYear = renderedProjects.reduce<Record<string, typeof renderedProjects>>( (acc, item) => {
  const k = String(item.year);
  (acc[k] ||= []).push(item);
  return acc;
}, {});

const years = Object.keys(byYear).sort((a, b) => Number(b) - Number(a));

const tagCounts = projects.reduce((acc, p) => {
  p.data.stack.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);
const uniqueTags = Array.from(new Set(projects.flatMap(p => p.data.stack))).sort((a, b) => (tagCounts[b] || 0) - (tagCounts[a] || 0));
---

<BaseLayout title="dago / portfolio">
  <Timeline>
    {projects.length > 0 ? (
      <FilterBar tags={uniqueTags} />

      <div class="timeline relative space-y-20 lt-sm:-ml-1.5em">
        {years.map((y) => (
          <section class="year-section">
            <h2 class="year sticky top-2 z-10 bg-bg pl-[calc(1.25rem_-_2px)] pr-2 py-2 inline-block leading-none">{y}</h2>

            <div class="space-y-12 mt-4">
              {byYear[y].map(({ project, Content }) => (
                <ProjectBlock
                  title={project.data.title}
                  date={project.data.date.toISOString()}
                  users={project.data.users}
                  url={project.data.url}
                  stack={project.data.stack}
                  screenshots={project.data.screens}
                >
                  <Content />
                </ProjectBlock>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <p>Bus. ;-)</p>
    )}
  </Timeline>
</BaseLayout>

<style>
  .year {
    border-left: 0.5rem solid currentColor;
    margin-left: calc(-0.5rem / 2 + 1px); /* aligns with timeline line */
  }

  .timeline::before {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background: color-mix(in oklab, currentColor 20%, transparent);
  }

  @media (max-width: 639.9px) {
    .year {
      border-left-width: 0.375rem;
      margin-left: calc(0.5em / 1.5); /* aligns with timeline line on small screens and 1.5 is the em of h2, that is parent of this class */
      padding-left: 0.5em;
    }

    .timeline::before {
      left: calc(0.5em + 0.375rem / 2 - 1px);
    }
  }
</style>